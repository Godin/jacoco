<?xml version="1.0" encoding="UTF-8"?>

<!--
   Copyright (c) 2009, 2025 Mountainminds GmbH & Co. KG and Contributors
   This program and the accompanying materials are made available under
   the terms of the Eclipse Public License 2.0 which is available at
   http://www.eclipse.org/legal/epl-2.0

   SPDX-License-Identifier: EPL-2.0

   Contributors:
      Evgeny Mandrikov - initial API and implementation
-->

<project name="JaCoCo with Java SecurityManager Test" xmlns:au="antlib:org.apache.ant.antunit" xmlns:jacoco="antlib:org.jacoco.ant">

	<target name="setUp">
		<tempfile property="temp.dir" prefix="jacocoTest" destdir="${java.io.tmpdir}" />
		<mkdir dir="${temp.dir}"/>
		<property name="exec.file" location="${temp.dir}/jacoco.exec" />
	</target>

	<target name="tearDown">
		<delete dir="${temp.dir}" quiet="false" failonerror="true"/>
	</target>

	<target name="testJaCoCoWithJmx">
		<echo file="${temp.dir}/jmxremote.access">user readonly</echo>
		<echo file="${temp.dir}/jmxremote.password">user password</echo>
		<chmod file="${temp.dir}/jmxremote.password" perm="600"/>
		<jacoco:coverage output="none" jmx="true" sessionId="test-session">
			<java classname="org.jacoco.ant.JmxTarget" fork="true" failonerror="true">
				<classpath path="${org.jacoco.ant.jmxTest.classes.dir}"/>
				<jvmarg value="-Dcom.sun.management.jmxremote.local.only=true"/>
				<jvmarg value="-Dcom.sun.management.jmxremote.port=9999"/>
				<jvmarg value="-Dcom.sun.management.jmxremote.authenticate=true"/>
				<jvmarg value="-Dcom.sun.management.jmxremote.access.file=${temp.dir}/jmxremote.access"/>
				<jvmarg value="-Dcom.sun.management.jmxremote.password.file=${temp.dir}/jmxremote.password"/>
				<jvmarg value="-Dcom.sun.management.jmxremote.ssl=false"/>
				<jvmarg value="-Djava.rmi.server.hostname=localhost"/>
			</java>
		</jacoco:coverage>

		<au:assertLogContains text="Target executed: test-session"/>
	</target>

</project>
