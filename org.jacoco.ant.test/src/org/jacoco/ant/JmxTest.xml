<?xml version="1.0" encoding="UTF-8"?>

<!--
   Copyright (c) 2009, 2026 Mountainminds GmbH & Co. KG and Contributors
   This program and the accompanying materials are made available under
   the terms of the Eclipse Public License 2.0 which is available at
   https://www.eclipse.org/legal/epl-2.0

   SPDX-License-Identifier: EPL-2.0

   Contributors:
      Evgeny Mandrikov - initial API and implementation
-->

<project name="JaCoCo with JMX Test" xmlns:au="antlib:org.apache.ant.antunit" xmlns:jacoco="antlib:org.jacoco.ant">

	<target name="setUp">
		<tempfile property="temp.dir" prefix="jacocoTest" destdir="${java.io.tmpdir}" />
		<mkdir dir="${temp.dir}"/>
	</target>

	<target name="tearDown">
		<delete dir="${temp.dir}" quiet="false" failonerror="true"/>
	</target>

	<target name="testJaCoCoWithJmx">
		<echo file="${temp.dir}/jmxremote.access">user readonly</echo>
		<echo file="${temp.dir}/jmxremote.password">user password</echo>

		<chmod file="${temp.dir}/jmxremote.password" perm="600"/>

		<exec osfamily="windows" failonerror="true" executable="icacls">
			<arg value="${temp.dir}\\jmxremote.password"/>
			<arg value="/reset"/>
		</exec>
		<exec osfamily="windows" failonerror="true" executable="icacls">
			<arg value="${temp.dir}\\jmxremote.password"/>
			<arg value="/grant:r"/>
			<arg value="${user.name}:R"/>
		</exec>
		<exec osfamily="windows" failonerror="true" executable="icacls">
			<arg value="${temp.dir}\\jmxremote.password"/>
			<arg value="/inheritance:r"/>
		</exec>

		<property name="sessionId" value="JmxTarget"/>
		<jacoco:coverage output="none" jmx="true" sessionId="${sessionId}">
			<java classname="org.jacoco.ant.JmxTarget" fork="true" failonerror="true">
				<classpath path="${org.jacoco.ant.jmxTest.classes.dir}"/>
				<jvmarg value="-Dcom.sun.management.jmxremote.authenticate=true"/>
				<jvmarg value="-Dcom.sun.management.jmxremote.access.file=${temp.dir}/jmxremote.access"/>
				<jvmarg value="-Dcom.sun.management.jmxremote.password.file=${temp.dir}/jmxremote.password"/>
				<jvmarg value="-Dcom.sun.management.jmxremote.ssl=true"/>
				<jvmarg value="-Dcom.sun.management.jmxremote.ssl.need.client.auth=true"/>
				<!--
				keytool -genkeypair -alias test -keyalg RSA -keysize 2048 -validity 36500 \
					-keystore keystore.jks -storepass password -keypass password -dname "CN=localhost"
				-->
				<jvmarg value="-Djavax.net.ssl.keyStore=${basedir}/data/keystore.jks"/>
				<jvmarg value="-Djavax.net.ssl.keyStorePassword=password"/>
				<jvmarg value="-Djavax.net.ssl.trustStore=${basedir}/data/keystore.jks"/>
				<jvmarg value="-Djavax.net.ssl.trustStorePassword=password"/>
				<jvmarg value="-Dcom.sun.management.jmxremote.port=9999"/>
				<jvmarg value="-Dcom.sun.management.jmxremote.host=localhost"/>
				<jvmarg value="-Djava.rmi.server.hostname=localhost"/>
			</java>
		</jacoco:coverage>

		<au:assertLogContains text="Target executed: ${sessionId}"/>
	</target>

</project>
